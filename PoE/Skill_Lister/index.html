<!DOCTYPE html>
<html lang="en" dir="ltr" style="height: 100%">
  <head>
    <meta charset="utf-8">
    <title>PoE skill lister</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/style.min.css">
    <script type="text/javascript">
      function lightTheme() {
        document.documentElement.style.setProperty('--background-color', "rgb(255, 255, 255)");
        document.documentElement.style.setProperty('--background-color-70', "rgba(255, 255, 255, 0.7)");
        document.documentElement.style.setProperty('--background-color-50', "rgba(255, 255, 255, 0.5)");
        document.documentElement.style.setProperty('--background-color-30', "rgba(255, 255, 255, 0.3)");
        document.documentElement.style.setProperty('--background-low-contrast', "rgb(249, 249, 249)");
        document.documentElement.style.setProperty('--background-contrast', "rgb(244, 244, 244)");
        document.documentElement.style.setProperty('--text', "#222");
        document.documentElement.style.setProperty('--link', "#1EAEDB");
        document.documentElement.style.setProperty('--link-hover', "#0FA0CE");
      }

      function darkTheme() {
        document.documentElement.style.setProperty('--background-color', "rgb(45, 45, 45)");
        document.documentElement.style.setProperty('--background-color-70', "rgba(45, 45, 45, 0.7)");
        document.documentElement.style.setProperty('--background-color-50', "rgba(45, 45, 45, 0.5)");
        document.documentElement.style.setProperty('--background-color-30', "rgba(45, 45, 45, 0.3)");
        document.documentElement.style.setProperty('--background-low-contrast', "rgb(42, 42, 42)");
        document.documentElement.style.setProperty('--background-contrast', "rgb(38, 38, 38)");
        document.documentElement.style.setProperty('--text', "#dfdfdf");
        document.documentElement.style.setProperty('--link', "#1EAEDB");
        document.documentElement.style.setProperty('--link-hover', "#0FA0CE");
      }

      if (window.localStorage.getItem('theme') == null) {
        window.localStorage.setItem('theme', 'light');
      } else if (window.localStorage.getItem('theme') == 'dark') {
        darkTheme();
      }

      function switchTheme() {
        if (window.localStorage.getItem('theme') == 'light') {
          window.localStorage.setItem('theme', 'dark');
          darkTheme();
          document.getElementById("toDarkTheme").style.display = "none";
          document.getElementById("toLightTheme").style.display = "block";
        } else {
          window.localStorage.setItem('theme', 'light');
          lightTheme();
          document.getElementById("toLightTheme").style.display = "none";
          document.getElementById("toDarkTheme").style.display = "block";
        }
      }
  </script>
  </head>
  <body style="height: 100%">
    <div class="theme-toggle" onclick="switchTheme()">
      <img id="toDarkTheme" src="img/dark-theme.svg" style="display: none;">
      <img id="toLightTheme" src="img/light-theme.svg" style="display: block;">
    </div>
    <header style="background: linear-gradient(to top right, #3399ff 0%, #00ffcc 100%);padding: 0;margin: 0;line-height: 0;">
      <h1 class="separator title">Path of Exile Skill Lister</h1>
    </header>
    <div class="container">
      <h6>Basic</h6>
      <button class="chip" onclick="toggleType(this);">Attack</button>
      <button class="chip" onclick="toggleType(this);">Melee</button>
      <button class="chip" onclick="toggleType(this);">Spell</button>
    </div>
    <div class="container">
      <h6>Weapon Type</h6>
      <button class="chip" onclick="toggleType(this);">Two-Handed</button>
      <button class="chip" onclick="toggleType(this);">One-Handed</button>
      <button class="chip" onclick="toggleType(this);">Dual-Wielding</button>
      <button class="chip" onclick="toggleType(this);">Axe</button>
      <button class="chip" onclick="toggleType(this);">Sword</button>
      <button class="chip" onclick="toggleType(this);">Mace</button>
      <button class="chip" onclick="toggleType(this);">Claw</button>
      <button class="chip" onclick="toggleType(this);">Dagger</button>
      <button class="chip" onclick="toggleType(this);">Staff</button>
      <button class="chip" onclick="toggleType(this);">Wand</button>
      <button class="chip" onclick="toggleType(this);">Bow</button>
      <button class="chip" onclick="toggleType(this);">Sceptre</button>
      <button class="chip" onclick="toggleType(this);">Unarmed</button>
    </div>
    <div class="container">
      <h6>Element</h6>
      <button class="chip" onclick="toggleType(this);">Chaos</button>
      <button class="chip" onclick="toggleType(this);">Cold</button>
      <button class="chip" onclick="toggleType(this);">Fire</button>
      <button class="chip" onclick="toggleType(this);">Physical</button>
      <button class="chip" onclick="toggleType(this);">Lightning</button>
    </div>
    <div class="container">
      <h6>Gem Tag</h6>
      <button class="chip" onclick="toggleType(this);">AoE</button>
      <button class="chip" onclick="toggleType(this);">Aura</button>
      <button class="chip" onclick="toggleType(this);">Blink</button>
      <button class="chip" onclick="toggleType(this);">Brand</button>
      <button class="chip" onclick="toggleType(this);">Chaining</button>
      <button class="chip" onclick="toggleType(this);">Channelling</button>
      <button class="chip" onclick="toggleType(this);">Curse</button>
      <button class="chip" onclick="toggleType(this);">Duration</button>
      <button class="chip" onclick="toggleType(this);">Golem</button>
      <button class="chip" onclick="toggleType(this);">Guard</button>
      <button class="chip" onclick="toggleType(this);">Mine</button>
      <button class="chip" onclick="toggleType(this);">Minion</button>
      <button class="chip" onclick="toggleType(this);">Movement</button>
      <button class="chip" onclick="toggleType(this);">Projectile</button>
      <button class="chip" onclick="toggleType(this);">Strike</button>
      <button class="chip" onclick="toggleType(this);">Totem</button>
      <button class="chip" onclick="toggleType(this);">Trap</button>
      <button class="chip" onclick="toggleType(this);">Travel</button>
      <button class="chip" onclick="toggleType(this);">Trigger</button>
      <button class="chip" onclick="toggleType(this);">Warcry</button>
      <button class="chip" onclick="toggleType(this);">Slam</button>
    </div>
    <div class="container">
      <input class="chip" placeholder="Search skills by name" oninput="searchChange(this.value)"></input>
    </div>
    <header>
      <div class="container">
        <h4>Matching Skills:</h4>
        <div id="skilllist">
          <div class="skill">
            <img src="img/skill/Cyclone.png">
            <p>Cyclone</p>
          </div>
        </div>
      </div>
    </header>
    <header style="height: 100%"></header>
  </body>
  <script type="text/javascript">
    skillListElement = document.getElementById('skilllist');
    var skills,
        skillsFetch,
        previousSearch = "";
    getAndDisplaySkills();
    enabledTypes = [];
    disabledTypes = [];
    function toggleType(button) {
      if (!button.classList.contains('chip')) return;
      var state;

      if (button.classList[1] == undefined) {
        state = 0;
      } else {
        state = parseInt(button.classList[1]);
      }

      switch (state) {
        case 0:
          add(enabledTypes);
          button.classList.add("1");
          break;
        case 1:
          remove(enabledTypes);
          add(disabledTypes);
          button.classList.remove("1");
          button.classList.add("2");
          break;
        case 2:
          remove(disabledTypes);
          button.classList.remove("2");
          break;
      }

      filterSkills();
      displaySkills();


      function add(array) {
        array.push(button.innerText);
      }

      function remove(array) {
        for (var i = 0; i < array.length; i++) {
          if (array[i] == button.innerText) {
            array.splice(i, 1);
            return;
          }
        }
      }
    }

    function filterSkills() {
      skills = JSON.parse(skillsFetch);

      if (enabledTypes.length == 0 && disabledTypes.length == 0) {
        return;
      }

      for (var i = 0; i < disabledTypes.length; i++) {
        for (var o = 0; o < skills.skills.length; o++) {
          for (var p = 0; p < skills.skills[o].tags.length; p++) {
            if (skills.skills[o].tags[p] == disabledTypes[i]) {
              skills.skills.splice(o, 1);
              o--;
              break;
            }
            if (p == skills.skills[o].tags.length - 1) {
              break;
            }
          }
        }
      }

      for (var i = 0; i < enabledTypes.length; i++) {
        for (var o = 0; o < skills.skills.length; o++) {
          for (var p = 0; p < skills.skills[o].tags.length; p++) {
            if (skills.skills[o].tags[p] == enabledTypes[i]) {
              break;
            }
            if (p == skills.skills[o].tags.length - 1) {
              skills.skills.splice(o, 1);
              o--;
              break;
            }
          }
        }
      }
    }

    function searchChange(text) {
      if (previousSearch.length < text.length) {
        previousSearch = text;
        searchSkills(text);
        displaySkills();
      } else {
        previousSearch = text;
        filterSkills();
        searchSkills(text);
        displaySkills();
      }
    }

    function searchSkills(query) {
      for (var i = 0; i < skills.skills.length; i++) {
        // 0 = match, -1 = no match
        var string = skills.skills[i].name.toLowerCase();
        if (string.search(query.toLowerCase()) == -1) {
          skills.skills.splice(i, 1);
          i--;
        }
      }
    }

    function displaySkills() {
      result = '';
      if (skills.skills.length == 0) {
        skillListElement.innerHTML = result;
        return;
      }
      for (var i = 0; i < skills.skills.length; i++) {
        result += "<a class='skill' href='" + 'https://pathofexile.gamepedia.com/' + skills.skills[i].name.replace(/ /g, '_').replace(/'/g, '%27') + "'><img src=" + '"' + "img/skill/" + skills.skills[i].image + '"' + "><p>" + skills.skills[i].name + "</p></a>"
      }
      skillListElement.innerHTML = result;
    }

    function getAndDisplaySkills() {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          skillsFetch = this.responseText;
          skills = JSON.parse(skillsFetch);
          displaySkills();
        }
      };
      xmlhttp.open("GET", "data.json", true);
      xmlhttp.send();
    }
  </script>
</html>
