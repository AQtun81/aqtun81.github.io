<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <title>Speeddial</title>
  <meta name="description" content="">
  <meta name="author" content="AQtun">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Maven+Pro&amp;display=swap" rel="stylesheet">

  <link rel="stylesheet" href="../css/normalize.css">
  <link rel="stylesheet" href="../css/skeleton.css">
  <link rel="stylesheet" href="style.css">

</head>
<body onkeypress="return SearchKey(event)">
  <header style="position: fixed; width: 100%;">
    <div id="searchBody">
      <div id="search">
        <table class="u-full-width" style="margin: 0;">
          <tbody>
            <tr>
              <td style="padding: 0px;">
                <input id="searchInput" onkeyup="getQueryWikipedia(this.value)" type="text" placeholder="Search with Google"> <!-- // to be improved -->
                <img class="searchIcon" src="img/search.svg" onclick="SearchGoogle(document.getElementById('searchInput').value)">
              </td>
            </tr>
            <tr>
              <td onclick="SearchSuggestion(this.innerText)"></td>
            </tr>
            <tr>
              <td onclick="SearchSuggestion(this.innerText)"></td>
            </tr>
            <tr>
              <td onclick="SearchSuggestion(this.innerText)"></td>
            </tr>
            <tr>
              <td onclick="SearchSuggestion(this.innerText)"></td>
            </tr>
            <tr>
              <td onclick="SearchSuggestion(this.innerText)"></td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </header>
  <div id="websites"></div>

  <script type="text/javascript">
    var targetName,
        targetUrl;

    function addContextMenuEvent(element) {
      element.addEventListener('contextmenu', function(ev) {
          var menu = document.getElementById('contextMenu');
          ev.preventDefault();
          targetName = this.firstChild.innerText;
          targetUrl = this.attributes.href.nodeValue;

          document.getElementById('contextMenuEdit').children[1].innerText = "Edit " + targetName;
          document.getElementById('contextMenuRemove').children[1].innerText = "Remove " + targetName;
          document.getElementById('removeWebsiteButton').innerText = "Remove " + targetName;

          menu.style.display = "block";
          menu.style.left = ev.clientX + 'px';
          if (ev.clientY + window.scrollY > window.innerHeight - 200) {
            menu.style.top = ev.clientY + window.scrollY - 155 + 'px';
          } else {
            menu.style.top = ev.clientY + window.scrollY + 'px';
          }
          return false;
      }, false);
    }

    var websitesElement = document.getElementById('websites');
    function displayWebsiteTile(name, url) {
      websitesElement.innerHTML += '<div class="tile" href="' + url + '" onclick="openUrl(this.attributes.href.nodeValue)"><h4>' + name + '</h4></div>';
    }

    if (localStorage.getItem("websites") != null) {
      var localWebsites = localStorage.getItem("websites").split(',');
      for (website of localWebsites) {
        website = website.split('=');
        displayWebsiteTile(website[0], website[1])
      }
    }

    function refreshContextMenuEvents() {
      for (tile of document.getElementsByClassName('tile')) {
        addContextMenuEvent(tile);
      }
    }

    refreshContextMenuEvents();
  </script>

  <img id="settingsButton" class="toggle" onclick="openSettings()" src="img/settings.svg">
  <img id="addButton" class="toggle" onclick="openAddMenu()" src="img/add.svg">
  <div id="add" class="menu">
    <img id="closeAddButton" onclick="closeAddMenu()" src="img/close.svg" class="toggle">
    <h5>add website</h5>
    <label>Name</label>
    <input class="u-full-width" type="text" placeholder="google" id="add-name">
    <label>URL</label>
    <input class="u-full-width" type="url" placeholder="https://www.google.com/" id="add-url">
    <button onclick="addWebsite()">Add</button>
  </div>
  <div id="remove" class="menu">
    <h5>are you sure?</h5>
    <img id="closeRemoveButton" onclick="closeRemoveMenu()" src="img/close.svg" class="toggle">
    <button id="removeWebsiteButton" onclick="removeWebsite(targetName, targetUrl); closeRemoveMenu()">Remove ...</button>
  </div>
  <div id="settings" class="menu">
    <img id="closeSettingsButton" onclick="closeSettings()" src="img/close.svg" class="toggle">
    <h5>settings</h5>
    <label>Background</label>
    <input class="u-full-width" type="text" placeholder="url(), color, gradient">
    <input type="radio" name="showImages" value="false">
    <input type="radio" name="showImages" value="true">
    <button>Apply</button>
  </div>
  <div id="contextMenu">
    <table class="u-full-width" style="margin: 0;">
      <tbody>
        <tr>
          <td id="contextMenuAdd" onclick="openAddMenu()"><img src="img/add.svg"><bdo>Add New</bdo></td>
        </tr>
        <tr>
          <td id="contextMenuEdit" onclick="openEditMenu()"><img src="img/edit.svg"><bdo>Edit</bdo></td>
        </tr>
        <tr>
          <td id="contextMenuRemove" onclick="openRemoveMenu()"><img src="img/delete.svg"><bdo>Remove</bdo></td>
        </tr>
      </tbody>
    </table>
  </div>


  <script type="text/javascript">

    /* CONTEXT MENU
    ---------------------------------------------*/

    document.addEventListener('mouseup', function(ev) {
      document.getElementById('contextMenu').style.display = "none";
    }, false);

    /* OPENING AND CLOSING MENUS
    ---------------------------------------------*/

    var addMenu = document.getElementById("add");
    var settings = document.getElementById("settings");
    var removeMenu = document.getElementById('remove');
    var addMenuOpen = false;
    var settingsOpen = false;

    function openAddMenu() {
      if (addMenuOpen) {
        closeAddMenu();
      } else {
        addMenuOpen = true;
        addMenu.style.animationName = "openMenu";
        addMenu.style.animationDuration = "0.25s";
        if (settingsOpen) {
          closeSettings();
        }
      }
    }

    function closeAddMenu() {
      addMenu.style.animationName = "closeMenu";
      addMenu.style.animationDuration = "0.25s";
      addMenuOpen = false;
      document.getElementById("add-name").value = "";
      document.getElementById("add-url").value = "";
    }

    function openSettings() {
      if (settingsOpen) {
        closeSettings();
      } else {
        settingsOpen = true;
        settings.style.animationName = "openSettings";
        settings.style.animationDuration = "0.25s";
        if (addMenuOpen) {
          closeAddMenu();
        }
      }
    }

    function closeSettings() {
      settings.style.animationName = "closeSettings";
      settings.style.animationDuration = "0.25s";
      settingsOpen = false;
    }

    function openRemoveMenu() {
      removeMenu.style.animationName = "openMenu";
      removeMenu.style.animationDuration = "0.25s";
    }

    function closeRemoveMenu() {
      removeMenu.style.animationName = "closeMenu";
      removeMenu.style.animationDuration = "0.25s";
    }

    /* WEBSITE TILES
    ---------------------------------------------*/

    function addWebsite() {
      var name = document.getElementById("add-name").value;
      var url = document.getElementById("add-url").value;
      if (localStorage.getItem("websites") != null) {
        localStorage.setItem('websites', localStorage.getItem('websites') + ',' + name + '=' + url);
      } else {
        localStorage.setItem('websites', name + '=' + url);
      }
      closeAddMenu();
      displayWebsiteTile(name, url);
      tile = document.getElementsByClassName('tile')[document.getElementsByClassName('tile').length - 1];
      setWebsiteLogo(tile, getHost(tile.attributes.href.nodeValue));
      refreshContextMenuEvents();
    }

    function removeWebsiteTile(name, url) {
      var tiles = document.getElementsByClassName('tile');
      for (tile of tiles) {
        if (tile.children[0].innerText == name) {
          if (tile.attributes.href.nodeValue == url) {
            tile.remove();
            return
          }
        }
      }
      refreshContextMenuEvents();
    }

    function removeWebsite(name, url) {
      if (!localStorage.getItem('websites').endsWith((name + '=' + url))) {
        localStorage.setItem('websites', localStorage.getItem('websites').replace(name + '=' + url + ',', ''));
        removeWebsiteTile(name, url);
      } else {
        if (localStorage.getItem('websites').search(',') > -1) {
          localStorage.setItem('websites', localStorage.getItem('websites').replace(new RegExp(',' + name + '=' + url + '$'), ''));
          removeWebsiteTile(name, url);
        } else if (localStorage.getItem('websites') == name + '=' + url) {
          localStorage.removeItem('websites');
          removeWebsiteTile(name, url);
        }
      }
    }

    /* SEARCH
    ---------------------------------------------*/

    function openUrl(url) {
      window.open(url, "_self")
    }

    function getHost(url) {
      var result = url.match(/([^:\/\s]+)/g);
      if (result[0] == undefined || result[0] == null) {
        return
      }
      if (result[1] == undefined || result[1] == null) {
        if (result[0].match('.://')) {
          return
        }
        return result[0]
      }
      if (result[1].startsWith('www.')) {
        return result[1].substring(4, result[1].length)
      }
      return result[1]
    }

    var logoDatabase = ['google.com',
                        'youtube.com',
                        'music.youtube.com',
                        'twitter.com',
                        'docs.google.com',
                        'imdb.com',
                        'mail.google.com',
                        'reddit.com',
                        'twitch.tv',
                        'translate.google.com',
                        'morele.net',
                        'genius.com',
                        'rap.genius.com',
                        'wikipedia.org',
                        'xda-developers.com'];

    function isWebsiteLogoAvailable(host) {
      for (logo of logoDatabase) {
        if (host == logo) {
          return true
        }
      }
      return false
    }

    function setWebsiteLogo(element, host) {
      if (isWebsiteLogoAvailable(host)) {
        element.style.backgroundImage = 'url("img/logo/' + host + '.png")';
        element.classList.add('image');
      }
    }

    var tiles = document.getElementsByClassName('tile');
    for (tile of tiles) {
      setWebsiteLogo(tile, getHost(tile.attributes.href.nodeValue));
    }

    function Search(text) {
      if (text == undefined || text == null || text == "") {
        return
      }
      if (text.replace(/[^+]/g, "").length > 0) {
        for (i = 0; text.replace(/[^+]/g, "").length > 0; i += 1) {
          text = text.replace("+", "%2B");
        }
        for (i = 0; text.replace(/[^" "]/g, "").length > 0; i += 1) {
          text = text.replace(" ", "+");
        }
      } else {
        for (i = 0; text.replace(/[^" "]/g, "").length > 0; i += 1) {
          text = text.replace(" ", "+");
        }
        for (var i = 0; i < text.replace("#", "%23").length; i++) {
          text = text.replace("#", "%23");
        }
      }
      SearchGoogle(text);// to be improved
    }

    function SearchKey(e) {
      if (document.activeElement === document.getElementById('searchInput') && e.keyCode == 13) {
          Search(document.getElementById('searchInput').value);
      } else if (e.keyCode == 13) {
          document.getElementById("searchInput").focus();
      } else {
        document.getElementById('search').style.height = '45px';
      }
    }

    function SearchSuggestion(text) {
      document.getElementById('searchInput').value = text;
      Search(text);
    }

    /* SEARCH SUGGESTIONS
    ---------------------------------------------*/

    function showSuggestions(suggestions) {
      var elements = document.getElementById('search').firstElementChild.firstElementChild.children;
      for (var i = 0; i < 5; i++) {
        elements[i + 1].firstElementChild.innerText = suggestions[i];
      }
      document.getElementById('search').style.height = '291px';
    }

    function hideSuggestions() {
      if (document.activeElement === document.getElementById('searchInput')) {
        return
      }
      document.getElementById('search').style.height = '45px';
    }
    document.onmouseup = hideSuggestions;

    /* SEARCH ENGINES
    ---------------------------------------------*/

    function getQueryGoogle(q) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log(JSON.parse(this.responseText));
        }
      };
      xmlhttp.open("GET", "http://suggestqueries.google.com/complete/search?client=firefox&q=" + q, true);
      xmlhttp.send();
    }

    function getQueryGoogle(q, lang) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log(JSON.parse(this.responseText));
        }
      };
      xmlhttp.open("GET", "http://suggestqueries.google.com/complete/search?client=firefox&q=" + q + "&hl=" + lang, true);
      xmlhttp.send();
    }

    function SearchGoogle(text) {
      var url = "http://www.google.com/search?q=" + text;
      window.open(url,'_self');
    }

    function getQueryDuckDuckGo(q) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log(JSON.parse(this.responseText));
        }
      };
      xmlhttp.open("GET", "https://ac.duckduckgo.com/ac/?q=" + q + "&type=list", true);
      xmlhttp.send();
    }

    function SearchDuckDuckGo(text) {
      var url = "https://duckduckgo.com/?q=" + text;
      window.open(url,'_self');
    }

    function getQueryWikipedia(q) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          showSuggestions(JSON.parse(this.responseText)[1]);
        }
      };
      xmlhttp.open("GET", "https://en.wikipedia.org/w/api.php?action=opensearch&origin=*&search=" + q, true);
      xmlhttp.send();
    }

    function SearchWikipedia(text) {
      var url = "https://en.wikipedia.org/w/index.php?search=" + text;
      window.open(url,'_self');
    }

    function getQueryYahoo(q) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log(JSON.parse(this.responseText));
        }
      };
      xmlhttp.open("GET", "https://sugg.search.yahoo.net/sg/?output=jsonp&nresults=10&command=" + q, true);
      xmlhttp.send();
    }

    function SearchYahoo(text) {
      var url = "https://search.yahoo.com/search?p=" + text;
      window.open(url,'_self');
    }
  </script>
</body>
</html>
